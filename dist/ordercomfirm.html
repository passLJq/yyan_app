<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>订单确认</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
  <link rel="stylesheet" href="./common/css/api.css" />
  <link rel="stylesheet" href="./common/css/style.css">
  <link rel="stylesheet" href="./common/css/orderList.css">
  <link rel="stylesheet" href="./common/css/iconfont.css">
  <meta content="telephone=no" name="format-detection" />
  <style type="text/css">
    .page {
      background: #f8f8f8;
      width: 100%;
      overflow: hidden;
    }

    body {
      font-family: "微软雅黑";
      background: #f8f8f8;
      color: #656768
    }

    .order-content {
      position: relative;
      overflow: hidden;
      background-color: #f8f8f8;
      font-size: 17px;
      line-height: 1.41176471
    }

    .wy-media-box.address-select {
      margin-top: 0;
      border-bottom: 0;
      /* background:url(./image/location-border.png) repeat-x left bottom #fff; */
      background-size: auto 3px
    }

    .wy-media-box {
      margin: 10px 0;
      padding: 9pt 10px;
      border-top: 1px solid #e1e1e1;
      border-bottom: 1px solid #e1e1e1;
      background: #fff
    }

    .address-name {
      color: #232323;
      font-weight: 700;
      font-size: 15px
    }

    .address-name span {
      margin-right: 10px
    }

    .address-txt {
      color: #232323;
      font-size: 13px;
      line-height: 18px
    }

    .weui-media-box_appmsg .weui-media-box__hd.proinfo-txt-l {
      width: 30px;
      height: auto;
      vertical-align: top
    }

    .weui-media-box_appmsg .weui-media-box__hd {
      margin-right: 10px;
      width: 82px;
      height: 82px
    }

    .promotion-label-tit {
      color: #81838e;
      line-height: 15px
    }

    .promotion-label-tit img {
      width: 100%
    }

    img {
      border: 0;
      vertical-align: middle
    }

    .font-14 {
      font-weight: 400;
      font-size: 14px
    }

    blockquote,
    figure,
    form,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p {
      margin: 0
    }

    .mg-r-10 {
      margin-right: 10px
    }

    .fr {
      float: right
    }

    .txt-color-red {
      color: #e21323
    }

    .num {
      font-family: Arial, Helvetica, sans-serif
    }

    .sitem-tip,
    em,
    i,
    s {
      font-style: normal
    }

    .sitem-tip {
      padding: 2px 6px;
      background: #e21323;
      color: #fff;
      font-size: 9pt
    }

    .toolbar-inner .close-picker,
    .toolbar-inner .title,
    .weui_check_label .weui_cell_bd {
      font-size: 15px
    }

    .fontSize14 {
      font-size: 14px
    }

    .fontSize13 {
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .red {
      color: red
    }

    .color6 {
      color: #666
    }

    .bgd_white {
      background: #fff
    }

    .pay-container {
      position: fixed;
      bottom: 0;
      left: 0;
      z-index: 9999;
      display: block;
      box-sizing: border-box;
      width: 100%;
      border-top: 1px solid #f8f8f8;
      background-color: #fff;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none
    }

    .pull-right {
      float: right
    }

    .btn {
      position: relative;
      top: 0;
      box-sizing: border-box;
      margin-left: 9px;
      width: 110px;
      height: 50px;
      outline: 0;
      border: 1px solid #e5e5e5;
      border-radius: 0;
      background-color: #f44;
      color: #fff;
      font-size: 14px;
      cursor: pointer
    }

    .hg50 {
      height: 60px
    }

    .goods_checked_icon:before {
      font-size: 20px !important
    }

    .foot-black {
      clear: both;
      height: 3pc
    }

    .commodity_information_panel {
      margin-bottom: 10px;
      background: #fff
    }

    .commodity_information_title {
      overflow: hidden;
      width: auto;
      text-overflow: ellipsis;
      white-space: nowrap;
      word-wrap: normal;
      word-wrap: break-word;
      font-weight: 400;
      font-size: 15px;
      word-break: break-all
    }


    .default_receiving_address {
      padding: 20px 15px;
      background: #fff;
      color: #333;
      font-size: 15px
    }

    .default_receiving_address p:nth-child(1) {
      font-weight: 600
    }

    .default_receiving_address p:nth-child(2) {
      line-height: 18px
    }

    .default_address {
      display: inline-block;
      margin-left: 5px;
      width: 45px;
      background: red;
      color: #fff;
      text-align: center
    }

    .commodity_information {
      position: relative;
      display: flex;
      display: -webkit-box;
      display: -webkit-flex;
      padding: 14px 15px 10px;
      color: #656768;
      font-weight: 500;
      font-size: 15px
    }

    .weui-tabbar.wy-foot-menu {
      position: fixed
    }

    .weui-tabbar__item.npd,
    .wy-foot-menu .npd {
      padding: 2px 0
    }

    .cart-total-txt {
      color: #222;
      font-size: 15px;
      line-height: 40px
    }

    .cart-total-txt i {
      color: #e21323;
      font-size: 13px
    }

    .cart-total-txt em {
      color: #e21323;
      font-weight: 700;
      font-size: 1pc
    }

    .w-90 {
      width: 90px
    }

    .red-color {
      background-color: #e21323
    }

    .t-c {
      text-align: center
    }

    .promotion-foot-menu-label {
      color: #fff;
      font-size: 15px;
      line-height: 40px
    }

    .hide {
      display: none !important
    }

    .show {
      display: block
    }

    .wy-media-box.address-select {
      margin-top: 0;
      padding-top: 5px;
      padding-bottom: 5px;
      /* background: url(./image/location-border.png) repeat-x left bottom #fff; */
      border-bottom: 0;
      background-size: auto 3px;
    }

    /*跨境购 身份证添加 订单确认*/
    .idcardvcode {
      padding: 5px 15px;
      position: relative;
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
      background: #fff;
      margin-bottom: 10px
    }

    .idcardlabel {
      display: block;
      width: auto;
      word-wrap: break-word;
      word-break: break-all;
      font-size: 14px;
      padding: 5px 15px 5px 0;
    }

    .idcard_hd {
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      flex: 1;
      padding: 5px 0
    }

    .idcard_input {
      width: 100%;
      border: 0;
      outline: 0;
      -webkit-appearance: none;
      font-size: 14px;
      color: #999;
      height: 1.47058824em;
      line-height: 1.47058824
    }

    .idcard_ft {
      text-align: right;
      color: #999;
      border-left: 1px solid #E5E5E5;
    }

    .vcode-img {
      display: inline-block;
      height: 25px;
      margin-left: 5px;
      padding: 5px 0 5px .7em;
      line-height: 25px;
      vertical-align: middle
    }

    .vcode_btn {
      display: inline-block;
      height: 35px;
      padding: 0 0 0 .7em;
      line-height: 35px;
      vertical-align: middle;
      font-size: 14px;
      color: #999;
      background-color: transparent;
      border: 0;
      outline: 0;
    }

    .vcode_btn span {
      display: inline-block;
      padding: 0 5px;
    }

    .globalShopping {
      border: 1px solid #b162a3;
      font-size: 12px;
      border-radius: 10%;
    }

    .global {
      background: #b162a3;
      color: #fff;
      padding: 0 5px;
    }

    /*导航菜单*/
    #top {
      padding: 10px;
      height: 45px;
      box-sizing: border-box;
      border-bottom: 1px solid #A7A7A7;
    }

    .left-icon {
      float: left;
    }

    .left-icon>img {
      width: 20px;
      height: 20px;
    }

    #title {
      line-height: 30px;
      text-align: center;
    }

    #title>span {
      margin-left: -17.5px;
    }

    .weui-cell_access:active {
      background: #fff
    }

    a:active {
      background-color: #fff !important;
    }

    #head {
      position: fixed;
      top: 0;
      z-index: 9999;
      width: 100%;
      background: #fff !important;
      color: #427161;
    }

    #header {
      text-align: center;
      width: 100%;
      height: 48px;
      position: relative;
      background-color: #fff;
      color: #427161;
    }

    .promsg {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 80px;
    }

    #AddressText .useraddress {
      margin-bottom: 10px;
      width: 100%;
      padding: 10px 20px;
      box-sizing: border-box;
      border-top: 1px solid #f2f2f2;
      background-color: #fff;
    }

    .useraddress .msg {
      margin-left: 10px;
      width: 100%;
    }

    .useraddress .msg>p {
      font-size: 13px;
      margin-top: 10px;
    }

    .useraddress .msg p {
      margin-left: 0 !important;
    }

    .useraddress .msg .up {
      display: flex;
      justify-content: space-between;
    }

    .useraddress .msg .up .tit {
      font-size: 16px;
      font-weight: 500;
    }

    .addressModel {
      width: 100%;
      padding: 10px 20px;
      box-sizing: border-box;
      border-top: 1px solid #f2f2f2;
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .addressModel>div {
      display: flex;
      align-items: center;
      height: 100%;
    }

    .addressModel>div p:nth-child(2) {
      margin-left: 10px;
    }

    .addressModel p {
      font-size: 14px;
      color: #666464;
    }

    .addressModel p.icon-gengduo {
      font-size: 10px;
    }

    .addressModel .icon {
      font-size: 20px;
    }

    i.goods_checked_icon:before {
      color: #e69888 !important;
    }

    .weui_panel_hd:after,
    .weui_cell:before,
    .weui-cell:before {
      left: 4%;
      width: 92%;
    }
    
    .order-pay {
      position: fixed;
      bottom: -100%;
      left: 0;
      overflow: hidden;
      width: 100%;
      background-color: #fff;
      z-index: 9999999;
      transition-duration: 0.3s;
    }
    .order-pay.show {
      bottom: 0;
    }
    .order-pay .comBtn {
      width: 100%;
      color: #fff;
      background-color: #F5AC9E;
      padding: 10px 0;
      text-align: center;
    }
    .mark {
      position: fixed;
      background-color: rgba(0,0,0,.3);
      left: 0;
      width: 100%;
      top: 0;
      bottom: 0;
      z-index: 9999;
    }
  </style>
</head>

<body>
  <div class="page">
    <div id="head">

    </div>
    <!-- 默认收货地址 -->
    <div class="order-content">
      <!-- <div class="wy-media-box weui-media-box_text address-select hide" id="addAddress">
			    <div class="weui-media-box_appmsg" onclick="OpenAdressManage()">
			      <div class="weui-media-box__hd proinfo-txt-l"><div class="promotion-label-tit"><img src="./image/add8.png"></div></div>
			      <div class="weui-media-box__bd">
			        <div class="weui-cell_access">
			          <div class="address-name"><p style="color:#999">新增收货地址</p></div>
			        </div>
			      </div>
			      <div class="weui-media-box__hd proinfo-txt-l" style="width:16px;"><div class="weui-cell_access"><span class="weui-cell__ft"></span></div></div>
          </div> -->
      <div class="addressModel hide" onclick="OpenAdressManage()" id="addAddress">
        <div>
          <p class="icon iconfont icon-jia"></p>
          <p>新增收货地址</p>
        </div>
        <p class="icon iconfont icon-gengduo"></p>
      </div>
    </div>


    <div id="AddressText">
      <!-- <div class="useraddress addressModel">
          <div style="width: 90%">
            <p class="icon iconfont icon-location"></p>
            <div class="msg">
              <div class="up">
                <p class="tit">收货人：李某</p>
                <p class="">13456789045</p>
              </div>
              <p>收货地址：上海闵行区新地中心1栋101</p>
            </div>
          </div>
          <p class="icon iconfont icon-gengduo"></p>
        </div> -->
    </div>
    <div class="idcardvcode" id="div_idcard" style="display:none">
      <div class="weui-cell__hd">
        <label class="idcardlabel">身份证号</label>
      </div>
      <div class="idcard_hd">
        <input class="idcard_input" type="text" id="IdentityNO" value="" placeholder="请输入身份证号">
      </div>
      <div class="idcard_ft">
        <button class="vcode_btn" id="vcode_btn" style="display:none"><span id="vcode_save">保存</span><span class="colse"
            id="colse">取消</span></button>
        <img src="https://source.rushouvip.cn/WShopping/Image/edit_orderdetail.png" class="vcode-img" id="vcode-img"
          style="display:inline-block">
      </div>
    </div>
    <!-- 商品信息 -->
    <div id="prolist">

    </div>
    <!-- 支付方式2 -->
    <section style="padding:10px 0;font-size:14px;background-color:#fff;margin-top:10px" id="youhui">
      <div class="weui_cell weui_cell_select weui_select_after bgd_white fontSize14 up_line under_line">
        <div class="weui_cell_hd">
          <label for="" class="weui_label">
            优惠劵
          </label>
        </div>
        <div class="weui_cell_bd weui_cell_primary" style="text-align:right;padding-right:50px">
          <p id='y_num'>请选择优惠劵</p>
        </div>
      </div>
    </section>
    <div style="width: 345;height: 1px;background: #fff;padding: 0 15px;">
      <div style="margin: 0 auto;width: 100%;height: 1px;background: #f2f2f2;"></div>
    </div>

    <!-- <section onclick="openInv()" style="padding:10px 0;font-size:14px;background-color:#fff;margin-bottom:10px" id="fapiao">
                <div class="weui_cell weui_cell_select weui_select_after bgd_white fontSize14 up_line under_line">
                  <div class="weui_cell_hd">
                    <label for="" class="weui_label">
                      申请开票
                    </label>
                  </div>
                  <div class="weui_cell_bd weui_cell_primary" style="text-align:right;padding-right:50px">
                            <p id='fp_name'>不开发票</p>
                  </div>
                </div>
              </section> -->
    <div class="mark hide" id="mark" onclick="closePay()"></div>
    <div class="order-pay" id="paylist">

      <div class="weui_cell" id="div_cashpay">
        <div class="weui_cell_hd"><img src="./image/qianbao-pay.png" alt="" style="width:20px;margin-right:5px;display:block"></div>
        <div class="weui_cell_bd weui_cell_primary">
          <p class="fontSize14">钱包支付<span id='cashbalance'></span></p>
        </div>
        <div class="weui_cell_ft weui_cells_checkbox">
          <label class="weui_check_label">
            <div class="weui_cell_hd ">
              <input type="radio" class="weui_check selectpay" name="selectpay" data-payid="20170824112865489534"
                data-code="cashpay" onclick="SelectPayment(this)" checked="">
              <i class="weui_icon_checked goods_checked_icon" style="display: inline-block;vertical-align: bottom;"></i>
            </div>
          </label>
        </div>
      </div>
      <div class="weui_cell">
        <div class="weui_cell_hd"><img src="./image/weiXin-pay.png" alt="" style="width:20px;margin-right:5px;display:block"></div>
        <div class="weui_cell_bd weui_cell_primary">
          <p class="fontSize14">微信支付</p>
        </div>
        <div class="weui_cell_ft weui_cells_checkbox">
          <label class="weui_check_label">
            <div class="weui_cell_hd ">
              <input type="radio" class="weui_check selectpay" name="selectpay" data-payid="20180929145311965542"
                data-code="wxpay" onclick="SelectPayment(this)" checked="checked">
              <i class="weui_icon_checked goods_checked_icon" style="display: inline-block;vertical-align: bottom;"></i>
            </div>
          </label>
        </div>
      </div>
      <!-- 储存orderid -->
      <input type="hidden" id="orderid_by_create">
      <div class="comBtn" onclick="newPay()">确认</div>
      <!-- <div class="weui_cell no_access">
            <div class="weui_cell_hd"><img src="./image/zhifubao.png" alt="" style="width:20px;margin-right:5px;display:block"></div>
            <div class="weui_cell_bd weui_cell_primary">
                <p class="fontSize14">支付宝支付</p>
            </div>
            <div class="weui_cell_ft weui_cells_checkbox">
              <label class="weui_check_label" >
              <div class="weui_cell_hd ">
                  <input type="radio" class="weui_check selectpay" name="selectpay" data-payid="20091208120710069746" data-code="alipay" onclick="SelectPayment(this)"  checked="checked">
                  <i class="weui_icon_checked goods_checked_icon" style="display: inline-block;vertical-align: bottom;"></i>
              </div>
          </label>
            </div>
      </div> -->
    </div>
    <!--底部导航-->
    <div class="foot-black"></div>
    <div class="weui-tabbar wy-foot-menu">
      <div class="weui-tabbar__item  npd">
        <span style="color: #656768" class="cart-total-txt">应付：<span style="color: #656768" id="tprice">&yen;&nbsp;0.00</span>&nbsp;&nbsp;<span
            class="red" id="manjian"></span></span> </div>
      <a href="javascript:" id="comfirmOrder" class="npd w-90 t-c" style="background-color: #E69888">
        <p class="promotion-foot-menu-label">提交订单</p>
      </a>
    </div>
  </div>
  </div>
</body>
<script type="text/javascript" src="./common/js/api.js"></script>
<script src="https://cdn.bootcss.com/axios/0.18.0/axios.min.js"></script>
<script type="text/javascript" src="./common/js/SHA1.js"></script>
<script type="text/javascript" src="./common/js/config.js"></script>
<script type="text/javascript" src="./common/js/common.js"></script>
<script>
  var invoiceJson = ''; // 发票数据
  var isInvoice = false; // 是否开具发票
  var comfirmdata = [];
  var isreflashaddress = true;
  var idcard = "";
  var ishascrosspro = false; //是否有跨境商品
  var youhuijuan = [] //优惠劵数据
  var fanhuishuju = "" //返回优惠劵数据
  var yuanjiner = '' //全部商品总金额
  var isReboutPay = false
  var paypwdisnull = "0" //是否设置支付密码
  var addressid = "" //收货地址
  var payid = "" //支付ID
  var paycode = "" //支付方式
  var oid = "" //开团ID
  var onlyone = false //只允许重复提交一次
  var onlypay = false // 只允许提交一次付款
  var freight = {}
  freight.price = 0 // 运费
  freight.free = 0 // 包邮金额
  freight.in = 0 // 省内运费
  freight.out = 0 // 省外运费
  var couponPrice = 0 // 全局使用优惠券的减免金额
  var areacode = '' // 全局的地址id
  var isCreate = false  // 是否已经跑了创建订单接口
  if (openapp) {
    apiready = function () {
      isready()
    }
  } else {
    window.onload = function () {
      isready()
    }
  }
  var isready = function () {
    console.log(pageParam('gbskuid'))
    var statustop = $api.getStorage('statustop');
    // var statustop = 25
    if (openapp) {
      $api.dom('.order-content').style.marginTop = 45 + Number(statustop) + 'px'
      $api.dom('.wy-foot-menu').style.paddingBottom = api.getPrefs({
        sync: true,
        key: 'safeAreaBottom'
      }) + 'px'
      $api.byId('paylist').style.paddingBottom = api.getPrefs({
        sync: true,
        key: 'safeAreaBottom'
      }) + 'px'
      api.parseTapmode()
    }
    headTitle($api.byId('head'), '订单确认')
    if (checkLoginStatus()) {
      var way = pageParam('way')
      if (way == 'buynow' || way == 'groupbuynow') {
        BindData_BuyNow()
      } else {
        BindData_ShoppingCart();
      }
      BindMember();
    }
    if (window.api) {
      // headTitle($api.byId('head'),'订单确认')
      funListenLoginSuccess();
      // funListenAddressPage();
      // BindAdress()
      api.addEventListener({
        name: 'invoice_event'
      }, function (ret) {
        console.log(JSON.stringify(ret))
        get_inv(ret.value.key)
      })
    } else {
      BindAdress()
    }

    BindIDCartEvent();

  }

  /**
   * 下单重构=====================================开始=================================================
  */

  // 显示关闭付款框   有传type，表示是打开付款框
  function closePay(type) {
    var mark = $api.byId('mark')
    var pay = $api.byId('paylist')
    // 
    if (type) {
      mark.classList.remove('hide')
      pay.classList.add('show')
    } else {
      mark.classList.add('hide')
      pay.classList.remove('show')
      if (isCreate) {
        api.alert({
          title: '订单已创建，请到待付款列表支付',
          msg: '',
        }, function(ret, err) {
          api.closeWin()
        });
      }
    }
  }

  // 获取选择的付款方式与付款id
  function getPayMsg() {
    var selpay = $api.domAll($api.byId("paylist"), "[name=selectpay]");
    var payid = ''
    var paycode = ''
    for (var i = 0; i < selpay.length; i++) {
      var paycheck = $api.attr(selpay[i], "checked");
      if (paycheck == 'checked') {
        payid = $api.attr(selpay[i], "data-payid");
        paycode = $api.attr(selpay[i], "data-code");
      }
    }
    return {payid: payid, paycode: paycode}
  }

  // 去付款
  function newPay() {
    if (onlypay) {
      promptMsg('正在提交付款,请稍等');
      return;
    }
    onlypay = true
    var payData = getPayMsg()
    var orderids = $api.byId('orderid_by_create').value
    if (payData.paycode == 'cashpay') {
      hideLoading()
      var mewPayMount = $api.html($api.byId("tprice"))
      console.log(mewPayMount)
      mewPayMount = mewPayMount.substr(1, mewPayMount.length)
      console.log(mewPayMount)
      // 非手机就直接付款成功，不用输密码了
      if (!openapp) {
        newPayOrder()
      } else {
        api.openFrame({
          name: 'paypasswordframe',
          url: './paypasswordframe.html',
          rect: {
            x: 0,
            y: 0,
            w: 'auto',
            h: 'auto'
          },
          pageParam: {
            payAllPrice: mewPayMount,
            isSeted: paypwdisnull,
            payOrderWinName: api.winName,
            paySuccessBack: "newPayOrder"
          },
          bounces: false,
          bgColor: 'rgba(0,0,0,0.3)'
        });
      }
      
    } else {
      newPayOrder()
    }
  }
  function newPayOrder() {
    var payData = getPayMsg()
    var orderids = $api.byId('orderid_by_create').value
    showLoading()
    // 这里就是电脑上看的，手机上跑下面的 api.ajax
    if (!openapp) {
      console.log(JSON.stringify({
        orderId: orderids,
        paymentId: payData.payid,
        payCode: payData.paycode,
        memberId: getname(),
        devicetype: 1,
        devicemac: getname(),
        formId: ''
      }))
      https({
        url: siteUrl + 'Main/Shopping/PayOrder',
        method: 'POST',
        data: {
          orderId: orderids,
          paymentId: payData.payid,
          payCode: payData.paycode,
          memberId: getname(),
          devicetype: 1,
          devicemac: getname(),
          formId: ''
        },
        headers: 1,
        successBack: function (ret) {
          payBack(ret)
          // payFinish(ret.Data.orderids, payData.payid, payData.paycode, payBack(ret))
          // payFinish(ret.Data.orderids, payData.payid, payData.paycode, payBack, ret)
        }
      })
      return
    }
    // 手机端跑这里
    api.ajax({
      url: siteUrl + 'Main/Shopping/PayOrder',
      method: 'POST',
      data: {
        body:{
          orderId: orderids,
          paymentId: payData.payid,
          payCode: payData.paycode,
          memberId: getname(),
          devicetype: 1,
          devicemac: getname(),
          formId: ''
        }
      },
      headers: {
        "Authorization": window.api?api.getPrefs({sync: true,key: 'SessionKey'}):$api.getStorage('SessionKey'),
        "Content-Type": 'application/json; charset=utf-8'
      }
    }, function (ret, err) {
      console.log(JSON.stringify(ret))
      payBack(ret,err)
    })
  }
  function payBack(ret,err) {
    console.log('payback')
    var way = pageParam('way')
    var payData = getPayMsg()
    if (ret && ret.success) {
      if (ret.status == 1 && ret.success) {
        // 支付成功后跑一次订单查询
        // payFinish(ret.Data.orderids, payData.payid, payData.paycode)
        // 存起数据,留着到成功页跑订单查询的接口
        setname('payQuery', JSON.stringify({
          orderids: ret.Data.orderids,
          payid: payData.payid,
          paycode: payData.paycode
        }))
        if (payData.paycode == 'cashpay') {
          if (way == 'buynow' || way == 'groupbuynow') {
            if (ret.Data.ogid && ret.Data.ogid.length > 0) {
              ShoppingSuccess(paycode, "buynow", './groups_success.html', ret.Data.orderids, ret.Data.ogid, "isgroupswechatpay");
            } else {
              ShoppingSuccess(paycode, "buynow", './success.html', ret.Data.orderids);
            }
          } else if (way == 'shoppingcart') {
            ShoppingSuccess(paycode, "shoppingcart", './success.html', ret.Data.orderids);
          }
        } else if (payData.paycode == 'wxpay' && ret.Data.payorderinfo != '' && ret.Data.payorderinfo != null) {
          if (ret.Data.ogid && ret.Data.ogid.length > 0) {
            wechatpay(ret.Data.payorderinfo, 'wxpay', 'buynow', './groups_success.html', ret.Data.orderids, ret.Data.ogid, "isgroupswechatpay")
          } else {
            wechatpay(ret.Data.payorderinfo, 'wxpay', 'buynow', './success.html', ret.Data.orderids)
          }
        } else {
          pushMsg("订单号: [" + ret.Data.orderids + "] 订单提交成功,等待付款", ret.Data.orderids)
          promptMsg('下单成功');
        }
      }
      // 状态6 表示订单未创建成功，关闭付款弹窗，让用户重新提交订单 
      else if (ret.status == 6) {
        promptMsg(ret.err)
        // closePay()
      } else if (ret.status == 15) {
        promptMsg(ret.err)
      } else if (ret.status == 33 || ret.status == 35) {
        closePay()
        sceneMsg(ret.err, '是否继续支付重新开团？', '确定', cxPay, this)
      } else {
        promptMsg(ret.err)
      }
      onlypay = false
      onlyone = false
    } else {
      if (checkLoginStatus()) {
        promptMsg(err.msg);
      }
    }
    hideLoading()
  }
  // 重新付款
  function cxPay() {
    onlypay = false
    newPay()
  }
  // ================================================= 下单重构结束 =================================================

  //--------------监听事件
  function funListenLoginSuccess() {
    api.addEventListener({
      name: 'loginSuccess'
    }, function (ret, err) {
      if (ret) {
        var way = api.pageParam.way
        if (way == 'buynow' || way == 'groupbuynow') {
          BindData_BuyNow()
        } else {
          BindData_ShoppingCart();
        }
      }
    });
  }
  // function funListenAddressPage(){
  //   api.addEventListener({
  //       name:'viewappear'
  //   }, function(ret, err){
  //     if(isreflashaddress) {
  //       BindAdress()
  //     } else {
  //       isreflashaddress = true
  //     }
  //   });
  // }

  //--------------监听事件结束
  //--------------数据绑定
  function BindIDCartEvent() {
    var colse = $api.byId('colse');
    var vcodeBtn = $api.byId('vcode_btn');
    var vcodeImg = $api.byId('vcode-img');
    $api.addEvt(vcodeImg, 'click', function () {
      vcodeBtn.style.display = 'block';
      vcodeImg.style.display = 'none';
    });
    $api.addEvt(colse, 'click', function () {
      vcodeBtn.style.display = 'none';
      vcodeImg.style.display = 'block';
    });
    $api.addEvt($api.byId("vcode_save"), 'click', function () {
      vcodeBtn.style.display = 'none';
      vcodeImg.style.display = 'block';
      CheckOrSaveIDCard(true);
    });
  }

  function BindData_ShoppingCart() {
    showLoading()
    //购物车数据
    https({
      url: siteUrl + 'Main/Shopping/GetCartJson?uid=' + getname(),
      method: 'post',
      data: {
        uid: getname(),
        ids: pageParam('ids')
      },
      headers: 1,
      successBack: function (ret, err) {
        if (ret) {
          // console.log(JSON.stringify(ret))
          var isShipping = false // 是否开启限时购包邮
          if (ret.success) {
            if (ret.status == 1 && ret.Data != null) {
              var data = ret.Data.json;
              console.log(data)
              var shtml = '';
              var iscross = false;
              data.forEach(function (list, index) {
                var tprice = 0;
                shtml += '<div class="commodity_information_panel weui_panel_access">';
                shtml += '        <div class="weui_panel_hd commodity_information" style="color: #427161;">' +
                  list[0].shopname + '</div>';
                var caritemid = [];
                list.forEach(function (item, i) {
                  tprice = parseFloat(item.price * item.qty);
                  shtml += '        <div class="weui_panel_bd border_top">';
                  shtml +=
                    '            <a href="javascript:void(0);" class="weui_media_box weui_media_appmsg">';
                  shtml +=
                    '                <div class="weui_media_hd" style="width: 80px;height: 80px;">';
                  shtml += '                  <img class="weui_media_appmsg_thumb" src="' + item.pic +
                    '" alt="" style="min-height:100%;">';
                  shtml += '                </div>';
                  shtml += '                <div class="weui_media_bd promsg">';
                  if (data.iscross) {
                    ishascrosspro = true;
                    $api.attr($api.byId('div_idcard'), 'style', 'block');
                    shtml +=
                      '                 <span class="globalShopping"><span class="global">全球购</span></span>';
                  }
                  shtml +=
                    '                    <h4 class="commodity_information_title" style="color:#656768;">' +
                    item.productname + '</h4>';
                  shtml += '                      <p style="color: #9b9b9b;font-size:10px;">' + ((item.skutext !=
                    "" && item.skutext != null) ? item.skutext : '') + '</p>'
                  // shtml +='                    <p class="weui_media_desc"><span>数量：x'+pageParam('qty')+'</span>&nbsp;<span>'+((pageParam('skutext') !=""&&pageParam('skutext')!=null)?pageParam('skutext'):'')+'</span></p>';
                  // shtml +='                    <p class="fontSize13"><span style="color: #E69888;font-size: 12px;">&yen;</span><span style="color: #E69888;font-size: 17px;">&nbsp;'+ smallpirce.call(this,tprice)+'</span>&nbsp;&nbsp;<!--<span class="color6">会员折扣：80%</span>--></p>';
                  shtml +=
                    '<p class="fontSize13"><span><span style="color: #E69888;font-size: 12px;">&yen;</span><span style="color: #E69888;font-size: 17px;">&nbsp;' +
                    smallpirce.call(this, item.price) +
                    '</span>&nbsp;&nbsp;</span><span style="color: #656768">x' + item.qty + '</span></p>'
                  shtml += '                </div>';
                  shtml += '            </a>';
                  shtml += '        </div>';
                  caritemid.push(item.id);
                  youhuijuan.push({
                    shopid: item.shopid,
                    productID: item.isrushbuy ? '' : item.proid,
                    proskuid: item.skuid,
                    buycount: item.qty,
                    RushBuyID: item.isrushbuy ? item.prorushbuy.rushbuyid : ''
                  })
                  console.log(item.prorushbuy && item.prorushbuy.IsShipping)
                  if (item.prorushbuy && item.prorushbuy.IsShipping) {
                    isShipping = true
                  }
                });
                if (index == data.length - 1) {
                  // shtml +='      <div class="weui_cell weui_cell_select weui_select_after bgd_white fontSize14 up_line under_line" id="baoyou">';
                  // shtml +='            <div class="weui_cell_hd">';
                  // shtml +='                <label for="" class="weui_label">配送方式</label>';
                  // shtml +='            </div>';
                  // shtml +='            <div class="weui_cell_bd weui_cell_primary">';
                  // shtml +='                <select class="weui_select" name="select2">';
                  // shtml +='                    <option value="1">全场包邮</option>';
                  // //shtml +='                    <option value="2">美国</option>';
                  // shtml +='                </select>';
                  // shtml +='            </div>';
                  // shtml +='        </div>';
                  shtml += '        <div class="weui-cell weui-cell_access" href="javascript:;">';
                  shtml += '          <div class="weui-cell__bd weui-cell_primary">';
                  shtml +=
                    '            <p class="font-14"><span class="mg-r-10">运费:&nbsp;&nbsp;<em class="num" id="freight" style="color: #E69888;">&yen;0.00</em></span><span class="fr">总计:&nbsp;&nbsp;<em class="num" style="color: #E69888;" id="totalPrice">&yen;' +
                    parseFloat(ret.Data.proAmount).toFixed(2) + '</em></span></p>';
                  shtml += '          </div>';
                  shtml += '      </div>';
                }
                shtml += '      <div class="weui_cell   bgd_white fontSize14">';
                shtml +=
                  '            <div class="weui_cell_hd"><label class="weui_label width70">买家留言</label></div>';
                shtml += '            <div class="weui_cell_bd weui_cell_primary">';
                shtml +=
                  '                <input style="font-size: 12px" class="weui_input" type="text" name="buyer_remark" placeholder="选填：填写内容已和卖家协商确认">';
                shtml += '            </div>';
                shtml += '        </div>';
                shtml += '    </div>';
                shtml += '</div>';
                comfirmdata.push({
                  companyId: list[0].shopid,
                  companyName: list[0].shopname,
                  remark: "",
                  delcode: "1",
                  freeFreight: 0,
                  cartItemsId: caritemid.join(','),
                  proid: "",
                  buynum: 0,
                  skuId: ""
                });
              });
              $api.addEvt($api.byId('youhui'), 'click', function () {
                openyouhui()
              });

              if (iscross) {
                $api.attr($api.byId('div_idcard'), 'style', 'block');
              }
              $api.html($api.byId('prolist'), shtml);
              yuanjiner = ret.Data.proAmount
              $api.html($api.byId('tprice'), '&yen;' + parseFloat(ret.Data.proAmount).toFixed(2));
              $api.addEvt($api.byId('comfirmOrder'), 'click', ComfirmOrder);
              console.log(isShipping)
              if (!isShipping) {
                freight.free = ret.Data.packagePrice // 包邮金额
                freight.in = ret.Data.provinceFreight // 山东省内运费
                freight.out = ret.Data.opPrice // 山东省外运费
              }
              // 为了修改运费，放到绑定数据后执行
              BindAdress()
            } else if (ret.status == 1) {} else {
              promptMsg(ret.err);
            }
          } else {
            promptMsg(ret.err);
          }
        } else {
          if (checkLoginStatus()) {
            promptMsg(err.msg);
          }
        }
        hideLoading()
      }
    });
  }

  function BindData_BuyNow() {
    console.log(111)
    showLoading()
    //立即购买商品数据
    https({
      url: siteUrl + 'Main/Main/GetProductDetailJson',
      method: 'get',
      data: {
        productId: pageParam('pid'),
        gbid: pageParam('gbid')
      },
      successBack: function (ret, err) {
        if (ret) {
          // console.log(JSON.stringify(ret))
          if (ret.success) {
            if (ret.status == 1 && ret.Data != null) {
              var data = ret.Data;
              var shtml = '';
              var skuid = pageParam('skuid')
              var tprice = parseFloat((skuid != "" && skuid != null) ? pageParam('skuprice') : data.saleprice);
              //判断是否显示抢购
              if (data.isrushbuy) {
                var seprice = $api.strToJson(data.rushbuy.specjson)[0].Price
                tprice = Number(seprice).toFixed(2)
                if (pageParam('skuprice') != '') {
                  tprice = Number(pageParam('skuprice')).toFixed(2)
                }
              }
              var danjia = parseFloat((pageParam('way') == 'groupbuynow') ? pageParam('gbprice') : tprice)
              tprice = parseFloat((pageParam('way') == 'groupbuynow') ? pageParam('gbprice') : tprice) *
                pageParam('qty')
              shtml += '<div class="commodity_information_panel weui_panel_access">';
              shtml += '        <div class="weui_panel_hd commodity_information">' + data.shopname + '</div>';
              shtml += '        <div class="weui_panel_bd border_top">';
              shtml += '            <a href="javascript:void(0);" class="weui_media_box weui_media_appmsg">';
              shtml += '                <div class="weui_media_hd" style="width: 80px;height: 80px;">';
              shtml += '                  <img class="weui_media_appmsg_thumb" src="' + data.pic +
                '" alt="" style="min-height:100%;">';
              shtml += '                </div>';
              shtml += '                <div class="weui_media_bd promsg">';
              // if(data.iscross){
              //   ishascrosspro = true;
              //   $api.attr($api.byId('div_idcard'), 'style', 'block');
              //   shtml +='                 <span class="globalShopping"><span class="global">全球购</span></span>';
              // }
              shtml += '                    <h4 class="commodity_information_title" style="color:#656768;">' +
                data.name + '</h4>';
              shtml += '                      <p style="color: #9b9b9b;font-size:10px;">' + ((pageParam('skutext') !=
                "" && pageParam('skutext') != null) ? pageParam('skutext') : '') + '</p>'
              // shtml +='                    <p class="weui_media_desc"><span>数量：x'+pageParam('qty')+'</span>&nbsp;<span>'+((pageParam('skutext') !=""&&pageParam('skutext')!=null)?pageParam('skutext'):'')+'</span></p>';
              // shtml +='                    <p class="fontSize13"><span style="color: #E69888;font-size: 12px;">&yen;</span><span style="color: #E69888;font-size: 17px;">&nbsp;'+ smallpirce.call(this,tprice)+'</span>&nbsp;&nbsp;<!--<span class="color6">会员折扣：80%</span>--></p>';
              shtml +=
                '<p class="fontSize13"><span><span style="color: #E69888;font-size: 12px;">&yen;</span><span style="color: #E69888;font-size: 17px;">&nbsp;' +
                smallpirce.call(this, danjia) + '</span>&nbsp;&nbsp;</span><span style="color: #656768">x' +
                pageParam('qty') + '</span></p>'
              shtml += '                </div>';
              shtml += '            </a>';
              shtml += '        </div>';
              // shtml +='      <div class="weui_cell weui_cell_select weui_select_after bgd_white fontSize14 up_line under_line" id="baoyou">';
              // shtml +='            <div class="weui_cell_hd">';
              // shtml +='                <label for="" class="weui_label">配送方式</label>';
              // shtml +='            </div>';
              // shtml +='            <div class="weui_cell_bd weui_cell_primary">';
              // shtml +='                <select class="weui_select" name="select2" disabled>';
              // shtml +='                    <option value="1">全场包邮</option>';
              // //shtml +='                    <option value="2">美国</option>';
              // shtml +='                </select>';
              // shtml +='            </div>';
              // shtml +='        </div>';
              shtml += '        <div class="weui-cell weui-cell_access" href="javascript:;">';
              shtml += '          <div class="weui-cell__bd weui-cell_primary">';
              shtml +=
                '            <p class="font-14"><span class="mg-r-10">运费:&nbsp;&nbsp;<em class="num" id="freight" style="color: #E69888;">&yen;0.00</em></span><span class="fr">总计:&nbsp;&nbsp;<em class="num" style="color: #E69888;" id="totalPrice">&yen;' +
                tprice.toFixed(2) + '</em></span></p>';
              shtml += '          </div>';
              shtml += '      </div>';
              shtml += '      <div class="weui_cell   bgd_white fontSize14">';
              shtml +=
                '            <div class="weui_cell_hd"><label class="weui_label width70">买家留言</label></div>';
              shtml += '            <div class="weui_cell_bd weui_cell_primary">';
              shtml +=
                '                <input style="font-size: 12px" class="weui_input" type="text" name="buyer_remark" placeholder="选填：填写内容已和卖家协商确认">';
              shtml += '            </div>';
              shtml += '        </div>';
              shtml += '    </div>';
              shtml += '</div>';
              comfirmdata.push({
                companyId: data.companyid,
                companyName: data.shopname,
                remark: "",
                delcode: "1",
                freeFreight: 0,
                cartItemsId: '',
                proid: data.productid,
                buynum: pageParam('qty'),
                skuId: skuid
              });
              youhuijuan.push({
                shopid: data.companyid,
                productID: data.isrushbuy ? '' : data.productid,
                proskuid: skuid,
                buycount: pageParam('qty'),
                GBID: pageParam('gbid'),
                RushBuyID: data.isrushbuy ? data.rushbuy.rushbuyid : ''
              })
              $api.html($api.byId('prolist'), shtml);
              $api.html($api.byId('tprice'), '&yen;' + tprice.toFixed(2));
              $api.addEvt($api.byId('youhui'), 'click', function () {
                openyouhui()
              });
              yuanjiner = tprice
              $api.addEvt($api.byId('comfirmOrder'), 'click', BuyNow);
              if ((ret.Data.isrushbuy && ret.Data.rushbuy.IsShipping) || (pageParam('gbid') && ret.Data.GBIsShipping)) {
                // 开启了限时购包邮
              } else {
                freight.free = ret.packagePrice // 包邮金额
                freight.in = ret.provinceFreight // 山东省内运费
                freight.out = ret.opPrice // 山东省外运费
              }
              // 为了修改运费，放到绑定数据后执行
              BindAdress()
              console.log(freight)
            } else if (ret.status == 1) {} else {
              promptMsg(ret.err);
            }
          } else {
            promptMsg(ret.err);
          }
        } else {
          if (checkLoginStatus()) {
            promptMsg(err.msg);
          }
        }
        hideLoading()
      }
    })
  }
  // 根据地址码 判断运费
  function bindFreight() {
    console.log(333)
    var tf = Number(Number(yuanjiner) - Number(couponPrice))
    // console.log('tf = ' + tf)
    if (tf < freight.free) {
      // 37 开头为山东省内  areacode为全局的地址id
      if (areacode && areacode.toString().indexOf('37') == 0) {
        freight.price = freight.in
      } else {
        freight.price = freight.out
      }
    } else {
      freight.price = 0
    }
    //
    if ($api.byId('freight') != null) {
      $api.byId('freight').innerHTML = '￥' + Number(freight.price).toFixed(2)
    }
    if ($api.byId('totalPrice') != null) {
      $api.byId('totalPrice').innerHTML = '￥' + Number(Number(tf) + Number(freight.price)).toFixed(2)
    }
    if ($api.byId('tprice') != null) {
      $api.byId('tprice').innerHTML = '￥' + Number(Number(tf) + Number(freight.price)).toFixed(2)
    }
  }

  function BindAdress(addressid) {
    console.log(222)
    https({
      url: siteUrl + 'Main/Shopping/GetAddressJson',
      method: 'get',
      data: {
        uid: getname(),
        addressid: addressid
      },
      headers: 1,
      successBack: function (ret) {
        if (ret) {
          if (ret.success) {
            if (ret.status == 1 && ret.Data != null && ret.Data != "") {
              var data = ret.Data[0];
              var shtml = "";
              shtml += '<div class="useraddress addressModel" onclick="OpenAdressManage()">'
              shtml += '  <div style="width: 90%">'
              shtml += '    <p class="icon iconfont icon-location"></p>'
              shtml += '    <div class="msg">'
              shtml += '      <div class="up">'
              shtml += '        <p class="tit">收货人：' + data.name + '</p>'
              shtml += '        <p class="">' + data.mobile + '</p>'
              shtml += '      </div>'
              shtml += '      <p>收货地址：' + data.fullarea + data.address + '</p>'
              shtml += '    </div>'
              shtml += '  </div>'
              shtml += '  <p class="icon iconfont icon-gengduo"></p>'
              shtml += '</div>'
              shtml += '<input type="hidden" value="' + data.id + '" id="hideaddressid">';
              $api.addCls($api.byId("addAddress"), 'hide');
              $api.html($api.byId("AddressText"), shtml);
              areacode = data.areacode
              bindFreight()
            } else if (ret.status == 1) {
              areacode = ''
              $api.removeCls($api.byId("addAddress"), 'hide');
              bindFreight()
            } else {
              promptMsg(ret.err);
            }
          } else {
            promptMsg(ret.err);
          }
        } else {
          promptMsg(err.Msg)
        }
      }
    });
  }

  function BindMember() {
    https({
      url: siteUrl + 'Main/Member/GetMemberJson',
      method: 'get',
      data: {
        uid: getname()
      },
      headers: 1,
      successBack: function (ret, err) {
        console.log(ret)
        if (ret) {
          if (ret.success) {
            if (ret.status == 1 && ret.Data != null) {
              var data = ret.Data;
              paypwdisnull = ret.Data.paypwdisnull
              // if(data.isopenshop){
              $api.html($api.byId('cashbalance'), '(余额：' + parseFloat(data.blance).toFixed(2) + '元)');
              // }
              // else{
              //   $api.addCls($api.byId('div_cashpay'), 'hide');
              // }
              if (data.idcard != null && data.idcard != "") {
                $api.val($api.byId("IdentityNO"), data.idcard);
                idcard = data.idcard;
              }
            }
          }
        } else {
          promptMsg(err.msg);
        }
      }
    });
  }
  //--------------数据绑定结束
  function SelectPayment(obj) {
    var selpay = $api.domAll($api.byId("paylist"), "[name=selectpay]");
    for (var i = 0; i < selpay.length; i++) {
      $api.attr(selpay[i], 'checked', '');
    }
    $api.attr(obj, 'checked', 'checked');
  }

  function OpenAdressManage() {
    //OpenWebPage(bSiteUrl+'AddressList.aspx?shopid=170718164338876176&backurl=fromapp','收货地址');
    openWin({
      name: 'addressList',
      url: './addressList.html',
      pageParam: {
        isPayPage: 'ordercomfirm',
        title: '收货地址'
      }
    }, 1)
  }
  //外部web页面调用 更新地址方法
  function updateAddress(addressid) {
    isreflashaddress = false;
    BindAdress(addressid);
    if (window.api) {
      api.closeWin({
        name: 'addressList'
      });
    }
  }

  function ComfirmOrder() {
    //参数验证
    addressid = $api.val($api.byId('hideaddressid'));
    if (addressid == null || addressid == "") {
      promptMsg('请选择地址');
      return;
    }
    var selpay = $api.domAll($api.byId("paylist"), "[name=selectpay]");

    for (var i = 0; i < selpay.length; i++) {
      var paycheck = $api.attr(selpay[i], "checked");
      if (paycheck == 'checked') {
        payid = $api.attr(selpay[i], "data-payid");
        paycode = $api.attr(selpay[i], "data-code");
      }
    }
    if (payid == null || payid == "" || paycode == null || paycode == "") {
      promptMsg('请选择有效的支付方式');
      return;
    }
    if (comfirmdata.length < 1) {
      promptMsg('没有待支付商品');
      return;
    } else {
      var remarks = $api.domAll($api.byId('prolist'), "[name=buyer_remark]");
      for (var i = 0; i < remarks.length; i++) {
        comfirmdata[i].remark = $api.val(remarks[i]);
      }
    }
    //跨境
    if (ishascrosspro) {
      if (!CheckOrSaveIDCard()) {
        return;
      }
    }
    payorderCart()
    // closePay(1)
    // if (paycode == "cashpay") {
    //   hideLoading()
    //   var mewPayMount = $api.html($api.byId("tprice"))
    //   mewPayMount = mewPayMount.substr(1, mewPayMount.length)
    //   api.openFrame({
    //     name: 'paypasswordframe',
    //     url: './paypasswordframe.html',
    //     rect: {
    //       x: 0,
    //       y: 0,
    //       w: 'auto',
    //       h: 'auto'
    //     },
    //     pageParam: {
    //       payAllPrice: mewPayMount,
    //       isSeted: paypwdisnull,
    //       payOrderWinName: api.winName,
    //       paySuccessBack: "payorderCart"
    //     },
    //     bounces: false,
    //     bgColor: 'rgba(0,0,0,0.3)'
    //   });
    // } else {
    //   payorderCart()
    // }
  }
  // 购物车付款
  function payorderCart() {
    if (onlyone) {
      promptMsg('请勿重复提交,请重新下单');
      return;
    }
    showLoading()
    onlyone = true
    console.log(JSON.stringify({
        memberid: getname(),
        sourcetype: 0,
        addressid: addressid,
        timeid: "",
        payid: payid,
        paycode: paycode,
        data: comfirmdata,
        usercoupons: fanhuishuju,
        totalamount: yuanjiner,
        devicetype: 1,
        devicemac: getname(),
        OrdersFreight: freight.price
      }))
    https({
      // url: siteUrl + 'Main/ShoppingSinaPay/PayComfirmOrders?uid=' + getname(),
      url: siteUrl + 'Main/Shopping/PayOrderCreate?uid=' + getname(),   // 下单重构的新接口，创建订单
      method: 'post',
      data: {
        memberid: getname(),
        sourcetype: 0,
        addressid: addressid,
        timeid: "",
        payid: payid,
        paycode: paycode,
        data: comfirmdata,
        usercoupons: fanhuishuju,
        totalamount: yuanjiner,
        devicetype: 1,
        devicemac: getname(),
        OrdersFreight: freight.price
      },
      headers: 1,
      successBack: function (ret, err) {
        isCreate = true
        // 缓半秒再弹出付款
        var timer1 = setTimeout(function () {
          hideLoading()
          if (ret.success && ret.status == 1) {
            $api.val($api.byId('orderid_by_create'), ret.Data.orderids)
            closePay(1)
          } else {
            promptMsg(ret.err)
          }
          clearTimeout(timer1)
          timer1 = null
        }, 500)
      }
    })
    //购物车数据
    //钱包支付
    // if (paycode == 'cashpay') {
    //   https({
    //     url: siteUrl + 'Main/Shopping/PayComfirmOrders?uid=' + getname(),
    //     method: 'post',
    //     data: {
    //       memberid: getname(),
    //       sourcetype: 0,
    //       addressid: addressid,
    //       timeid: "",
    //       payid: payid,
    //       paycode: paycode,
    //       data: comfirmdata,
    //       usercoupons: fanhuishuju,
    //       totalamount: yuanjiner,
    //       OrdersFreight: freight.price
    //     },
    //     headers: 1,
    //     successBack: function (ret, err) {
    //       paycart_xinlang(ret)
    //     }
    //   });
    // } else if (paycode == 'wxpay') {
    //   https({
    //     url: siteUrl + 'Main/ShoppingSinaPay/PayComfirmOrders?uid=' + getname(),
    //     method: 'post',
    //     data: {
    //       memberid: api.getPrefs({
    //         sync: true,
    //         key: 'SessionUserID'
    //       }),
    //       sourcetype: 0,
    //       addressid: addressid,
    //       timeid: "",
    //       payid: payid,
    //       paycode: paycode,
    //       data: comfirmdata,
    //       usercoupons: fanhuishuju,
    //       totalamount: yuanjiner,
    //       devicetype: 1,
    //       devicemac: getname(),
    //       OrdersFreight: freight.price
    //     },
    //     headers: 1,
    //     successBack: function (ret, err) {
    //       paycart_xinlang(ret)
    //     }
    //   })
    // }
  }

  function paycart_xinlang(ret) {
    if (ret) {
      //支付刷新购物车页面
      if (window.api) {
        api.sendEvent({
          name: 'payorderCart'
        });
      }
      if (ret.success) {
        if (ret.status == 1 && ret.Data != null) {
          if (ret.Data.orderid) {}
          if (paycode == 'cashpay') {
            ShoppingSuccess(paycode, "shoppingcart", './success.html', ret.Data.orderids);
          } else if (paycode == 'alipay' && ret.Data.alipayorderinfo != null && ret.Data.alipayorderinfo != "") {
            var orderids = ret.Data.orderids
            console.log(orderids)
            var aliPayPlus = api.require('aliPayPlus');
            aliPayPlus.payOrder({
              orderInfo: decodeURIComponent(ret.Data.alipayorderinfo)
            }, function (rets, err) {
              if (rets.code == "9000") {
                //支付查状态
                ping_ordernow(orderids, '', rets.code)
                ShoppingSuccess(paycode, "shoppingcart", './success.html', orderids);
              } else {
                pushMsg("订单号: [" + orderids + "] 订单提交成功,等待付款", orderids)
                //支付查状态
                if (rets.code != '6001') {
                  ping_ordernow(orderids, '', rets.code)
                }
                api.alert({
                  title: '支付结果',
                  msg: alipayReturnCode(rets.code),
                  buttons: ['确定']
                });
                setTimeout(function () {
                  api.closeWin({
                    name: 'ordercomfirm'
                  });
                }, 1000)
              }
            });
          } else if (paycode == 'wxpay' && ret.Data.payorderinfo != null && ret.Data.payorderinfo != "") {
            wechatpay(ret.Data.payorderinfo, 'wxpay', 'buynow', './success.html', ret.Data.orderids)
          } else {
            pushMsg("订单号: [" + ret.Data.orderids + "] 订单提交成功,等待付款", ret.Data.orderids)
            promptMsg('下单成功');
          }
        } else if (ret.status == 33 || ret.status == 35) {
          sceneMsg(ret.err, '是否继续支付重新开团？', '确定', payCallBack, this)
        } else {
          promptMsg(ret.err);
        }
        onlyone = false // 跑完接口就放开 ， 以便余额不足时重新支付
      } else {
        promptMsg(ret.err);
      }
    }
    api.hideProgress();
  }

  function BuyNow() {
    //参数验证
    addressid = $api.val($api.byId('hideaddressid'));
    if (addressid == null || addressid == "") {
      promptMsg('请选择地址');
      return;
    }
    var selpay = $api.domAll($api.byId("paylist"), "[name=selectpay]");

    for (var i = 0; i < selpay.length; i++) {
      var paycheck = $api.attr(selpay[i], "checked");
      if (paycheck == 'checked') {
        payid = $api.attr(selpay[i], "data-payid");
        paycode = $api.attr(selpay[i], "data-code");
      }
    }
    if (payid == null || payid == "" || paycode == null || paycode == "") {
      promptMsg('请选择有效的支付方式');
      return;
    }
    if (comfirmdata.length < 1) {
      promptMsg('没有待支付商品');
      return;
    } else {
      var remarks = $api.domAll($api.byId('prolist'), "[name=buyer_remark]");
      comfirmdata.forEach(function (item, i) {
        comfirmdata[i].remark = $api.val(remarks[i]);
      });
    }
    //跨境
    if (ishascrosspro) {
      if (!CheckOrSaveIDCard()) {
        return;
      }
    }
    if (isReboutPay) {
      oid = ""
    } else {
      oid = pageParam('opengroupid')
    }
    if (paycode == "cashpay") {
      hideLoading()
      var mewPayMount = $api.html($api.byId("tprice"))
      console.log(mewPayMount)
      mewPayMount = mewPayMount.substr(1, mewPayMount.length)
      console.log(mewPayMount)
      api.openFrame({
        name: 'paypasswordframe',
        url: './paypasswordframe.html',
        rect: {
          x: 0,
          y: 0,
          w: 'auto',
          h: 'auto'
        },
        pageParam: {
          payAllPrice: mewPayMount,
          isSeted: paypwdisnull,
          payOrderWinName: api.winName,
          paySuccessBack: "payorderNow"
        },
        bounces: false,
        bgColor: 'rgba(0,0,0,0.3)'
      });
    } else {
      payorderNow()
    }

  }

  function payorderNow() {
    if (onlyone) {
      promptMsg('请勿重复提交,请重新下单');
      return;
    }
    showLoading()
    onlyone = true
    // comfirmdata.OrdersFreight = freight
    //直接购买
    // if (paycode == 'cashpay') {
    //   https({
    //     url: siteUrl + 'Main/Shopping/PayComfirmOrdersNow?uid=' + getname(),
    //     method: 'post',
    //     data: {
    //       memberid: getname(),
    //       sourcetype: 0,
    //       addressid: addressid,
    //       timeid: "",
    //       payid: payid,
    //       paycode: paycode,
    //       gbid: pageParam('gbid'),
    //       opengroupid: oid,
    //       data: comfirmdata,
    //       gbskuid: pageParam('gbskuid') ? pageParam('gbskuid') : '', // 有gbskuid表示拼团多规格
    //       usercoupons: fanhuishuju,
    //       rushbuyid: pageParam('rushbuyid'),
    //       OrdersFreight: freight.price,
    //       invoiceJson: invoiceJson, // 发票相关数据
    //       isInvoice: isInvoice, // true false 是否开发票
    //       devicetype: 1
    //     },
    //     headers: 1,
    //     successBack: function (ret, err) {
    //       xlang_buynow(ret)
    //     }
    //   });
    // } else if (paycode == 'wxpay') {
    //   https({
    //     // url: siteUrl + 'Main/ShoppingSinaPay/PayComfirmOrdersNow?uid=' + getname(),
    //     url: siteUrl + 'Main/Shopping/PayOrderCreate?uid=' + getname(),   // 下单重构的新接口，创建订单
    //     method: 'post',
    //     data: {
    //       memberid: getname(),
    //       sourcetype: 0,
    //       addressid: addressid,
    //       timeid: "",
    //       payid: payid,
    //       paycode: paycode,
    //       gbid: pageParam('gbid'),
    //       opengroupid: oid,
    //       data: comfirmdata,
    //       gbskuid: pageParam('gbskuid') ? pageParam('gbskuid') : '', // 有gbskuid表示拼团多规格
    //       usercoupons: fanhuishuju,
    //       rushbuyid: pageParam('rushbuyid'),
    //       OrdersFreight: freight.price,
    //       invoiceJson: invoiceJson, // 发票相关数据
    //       isInvoice: isInvoice, // true false 是否开发票
    //       devicetype: 1,
    //       devicemac: getname(),
    //       formid: '',
    //     },
    //     headers: 1,
    //     successBack: function (ret, err) {
    //       hideLoading()
    //       // xlang_buynow(ret)
    //       // 下单之后去选择执行支付
    //       $api.val($api.byId('orderid_by_create'), ret.Data.orderids)
    //       closePay(1)
    //     }
    //   });
    // }
    // console.log(JSON.stringify({
    //     memberid: getname(),
    //     sourcetype: 0,
    //     addressid: addressid,
    //     timeid: "",
    //     payid: payid,
    //     paycode: paycode,
    //     gbid: pageParam('gbid'),
    //     opengroupid: oid,
    //     data: comfirmdata,
    //     gbskuid: pageParam('gbskuid') ? pageParam('gbskuid') : '',
    //     usercoupons: fanhuishuju,
    //     rushbuyid: pageParam('rushbuyid'),
    //     OrdersFreight: freight.price,
    //     invoiceJson: invoiceJson,
    //     isInvoice: isInvoice,
    //     devicetype: 1,
    //     devicemac: getname(),
    //     formid: '',
    //   }))
    https({
      // url: siteUrl + 'Main/ShoppingSinaPay/PayComfirmOrdersNow?uid=' + getname(),
      url: siteUrl + 'Main/Shopping/PayOrderCreate?uid=' + getname(),   // 下单重构的新接口，创建订单
      method: 'post',
      data: {
        memberid: getname(),
        sourcetype: 0,
        addressid: addressid,
        timeid: "",
        payid: payid,
        paycode: paycode,
        gbid: pageParam('gbid'),
        opengroupid: oid,
        data: comfirmdata,
        gbskuid: pageParam('gbskuid') ? pageParam('gbskuid') : '', // 有gbskuid表示拼团多规格
        usercoupons: fanhuishuju,
        rushbuyid: pageParam('rushbuyid'),
        OrdersFreight: freight.price,
        invoiceJson: invoiceJson, // 发票相关数据
        isInvoice: isInvoice, // true false 是否开发票
        devicetype: 1,
        devicemac: getname(),
        formid: '',
      },
      headers: 1,
      successBack: function (ret, err) {
        isCreate = true
        hideLoading()
        // xlang_buynow(ret)
        // 下单之后去选择执行支付
        if (ret.success && ret.status == 1) {
          $api.val($api.byId('orderid_by_create'), ret.Data.orderids)
          closePay(1)
        } else {
          promptMsg(ret.err)
          onlyone = false
        }
      }
    });
  }
  //新浪支付立即购买
  function xlang_buynow(ret) {
    if (ret) {
      if (ret.success) {
        if (ret.status == 1 && ret.Data != null) {
          if (paycode == 'cashpay') {
            if (ret.Data.ogid && ret.Data.ogid.length > 0) {
              ShoppingSuccess(paycode, "buynow", './groups_success.html', ret.Data.orderids, ret.Data.ogid,
                "isgroupswechatpay");
            } else {
              ShoppingSuccess(paycode, "buynow", './success.html', ret.Data.orderids);
            }
          } else if (paycode == 'alipay' && ret.Data.alipayorderinfo != null && ret.Data.alipayorderinfo != "") {
            var orderids = ret.Data.orderids
            var payogid = ret.Data.ogid
            var aliPayPlus = api.require('aliPayPlus');
            aliPayPlus.payOrder({
              orderInfo: decodeURIComponent(ret.Data.alipayorderinfo)
            }, function (rets, err) {
              if (rets.code == "9000") {
                //支付查状态
                ping_ordernow(orderids, payogid, rets.code)
                if (payogid && payogid.length > 0) {
                  ShoppingSuccess(paycode, "buynow", './groups_success.html', orderids, payogid,
                    "isgroupswechatpay");
                } else {
                  ShoppingSuccess(paycode, "buynow", './success.html', orderids);
                }
              } else {
                //支付查状态
                if (rets.code != '6001') {
                  ping_ordernow(orderids, payogid, rets.code)
                }
                pushMsg("订单号: [" + orderids + "] 订单提交成功,等待付款", orderids)
                api.alert({
                  title: '支付结果',
                  msg: alipayReturnCode(rets.code),
                  buttons: ['确定']
                });
                setTimeout(function () {
                  closeWin('ordercomfirm')
                }, 1000)
              }
            });
          } else if (paycode == 'wxpay' && ret.Data.payorderinfo != null && ret.Data.payorderinfo != "") {
            if (ret.Data.ogid && ret.Data.ogid.length > 0) {
              wechatpay(ret.Data.payorderinfo, 'wxpay', 'buynow', './groups_success.html', ret.Data.orderids, ret.Data.ogid,
                "isgroupswechatpay")
            } else {
              wechatpay(ret.Data.payorderinfo, 'wxpay', 'buynow', './success.html', ret.Data.orderids)
            }
          } else {
            pushMsg("订单号: [" + ret.Data.orderids + "] 订单提交成功,等待付款", ret.Data.orderids)
            promptMsg('下单成功');
          }
        } else if (ret.status == 33 || ret.status == 35) {
          sceneMsg(ret.err, '是否继续支付重新开团？', '确定', payCallBack, this)
        } else {
          promptMsg(ret.err);
        }
        onlyone = false // 跑完接口就放开 ， 以便余额不足时重新支付
      } else {
        promptMsg(ret.err);
      }
    } else {
      if (checkLoginStatus()) {
        promptMsg(err.msg);
      }
    }
    hideLoading()
  }

  function CheckOrSaveIDCard(isupdate) {
    var textidcard = $api.val($api.byId('IdentityNO'));
    if (textidcard == null || textidcard == "") {
      promptMsg("请填写并保存身份证号码");
      return false;
    } else {
      //检验身份证
      var resmsg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
      if (!resmsg.test(textidcard)) {
        promptMsg('请填写正确的身份证号码');
        return false;
      } else {
        if (idcard != textidcard) {
          if (!isupdate) {
            promptMsg('您已修改了身份证号码，需先保存');
            return false;
          } else {
            https({
              url: siteUrl + 'Main/Member/UserEdit?uid=' + getname(),
              method: 'post',
              data: {
                uid: getname(),
                idcard: textidcard,
              },
              headers: 1,
              successBack: function (ret, err) {
                if (ret) {
                  if (ret.success) {
                    if (ret.status == 1 && isupdate) {
                      promptMsg("修改身份证号成功");
                      idcard = textidcard;
                    } else if (ret.status != 1) {
                      promptMsg(ret.err);
                      return false;
                    }
                    return true;
                  }
                }
              }
            });
          }
        } else {
          return true
        }
      }
    }
  }

  function close() {
    api.closeWin({
      name: 'ordercomfirm'
    });
  }

  function openyouhui() {
    openWin({
      name: 'use_coupon',
      url: './use_coupon.html',
      useWKWebView: true,
      pageParam: {
        sksk: youhuijuan,
        fanhuishuju: fanhuishuju,
        way: pageParam('way') == 'groupbuynow' ? 'groupbuynow' : ''
      }
    })
  }

  function shuju(i, paynum) {
    if (i == '') {
      fanhuishuju = ''; //清空数据
    } else {
      fanhuishuju = i.split(",")
    }
    // paynum 全局的使用优惠券金额
    if (paynum) {
      couponPrice = paynum // 优惠券的金额
    } else {
      couponPrice = 0
    }
    yuanjiner = Number(yuanjiner).toFixed(2)
    var yuan = ''
    yuan = (Number(yuanjiner) - Number(paynum)).toFixed(2)
    if (paynum == 0) {
      $api.html($api.byId('y_num'), '请选择优惠劵');
      $api.html($api.byId('tprice'), '&yen;' + yuanjiner)
      $api.html($api.byId('manjian'), '')
    } else {
      $api.html($api.byId('y_num'), '已使用' + fanhuishuju.length + '张优惠劵');
      $api.html($api.byId('manjian'), '优惠:&yen;&nbsp;' + paynum)
    }
    bindFreight()
  }

  function payCallBack() {
    isReboutPay = true
    BuyNow()
  }
  // 打开发票frame页
  function openInv() {
    api.openFrame({
      name: 'invoice',
      url: './invoice.html',
      // bgColor: 'rgba(0,0,0,.3)'
      pageParam: {
        invoiceJson: invoiceJson
      }
    })
  }
  // 获取开发票的数据
  function get_inv(value) {
    invoiceJson = {}
    for (var i in value) {
      invoiceJson[i] = value[i]
    }
    isInvoice = invoiceJson.invoiceType ? true : false
    $api.byId('fp_name').innerHTML = invoiceJson.invoiceType ? invoiceJson.invoiceTitle == 1 ? '个人' : '公司' : '不开发票'
  }
</script>

</html>